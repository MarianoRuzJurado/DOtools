---
title: "Introduction"
author:
  - name: Mariano Ruz Jurado
    affiliation:
    - Goethe University
output: 
  BiocStyle::html_document:
    self_contained: true
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: show
package: "`r pkg_ver('DOtools')`"
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r chunk_setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

```{r vignette_setup, echo=FALSE, message=FALSE, warning = FALSE}
# Track time spent on making the vignette.
start_time <- Sys.time()

# Bib setup.
library(RefManageR)

# Write bibliography information
bib <- c(
    DOtools = citation("DOtools")[1],
    scDbl = citation("scDblFinder")[2],
    Seurat = citation("Seurat")[3]
)
```

# Installation
`r Biocpkg("DOtools")` is an R package distributed as part of the Bioconductor
project. To install the package, start R and enter:

```{r bioconductor_install, eval=FALSE}
install.packages("BiocManager") # WORK iN PROGRESS
BiocManager::install("DOtools")
```

Alternatively, you can instead install the latest development version from [GitHub](https://github.com/) with:

```{r github_install, eval=FALSE}
install.packages("devtools")
devtools::install_github("MarianoRuzJurado/DOtools")
```

# Usage
`r Biocpkg("DOtools")` contains different functions
for processing and visualizing gene expression in scRNA/snRNA experiments:

In this vignette we showcase how to use the functions with public available data.

## Libraries

`r Biocpkg("DOtools")` can be imported as:

```{r load_library, message=FALSE}
library(DOtools)

#Additional packages
library(Seurat)

#Additional reticulate python set
reticulate::use_python("~/miniconda3/envs/pycharm_py11/bin/python")
```

## Quality control
`r Biocpkg("DOtools")` The `r DO.Import()` function provides a streamlined pipeline for performing quality control on single-cell or single-nucleus RNA sequencing (sc/snRNA-seq) data. It takes as input a list of .h5 files generated by e.g. CellRanger or STARsolo, along with sample names and metadata.

During preprocessing, low-quality genes and cells are filtered out based on specified thresholds. Genes expressed in fewer than five cells are removed. Cells are filtered according to mitochondrial gene content, number of detected genes, total UMI counts, and potential doublets. The function supports doublet detection using `r Biocpkg("scDblFinder")` `r Citep(bib[["scDblFinder"]])`. Thresholds for mitochondrial content (e.g., 5% for scRNA-seq and 3% for snRNA-seq), gene counts, and UMI counts can be defined to tailor the filtering.

After filtering, samples are merged into one `r Biocpkg("Seurat")` `r Citep(bib[["Seurat"]])` object, followed by log-normalisation, scaling, and the identification of highly variable genes. To help assess the effect of quality control, violin plots showing distributions of key metrics before and after filtering are automatically generated and saved alongside the input files. A summary of removed genes and cells is also recorded. 

To show how the quality control works, we are going to use a public dataset from 10X from human blood of healthy and donors with a malignant tumor:

```{r read_example_data}
DOtools:::.example_10x()

paths = c("/tmp/dotools_datasets/healthy/outs/filtered_feature_bc_matrix.h5",
         "/tmp/dotools_datasets/disease/outs/filtered_feature_bc_matrix.h5")

Seu_obj <- DO.Import(pathways = paths,
                     ids = c("healthy-1", "disease-1"),
                     TenX = T,
                     DeleteDoublets = T,
                     cut_mt = .05,
                     min_counts = 500,
                     min_genes = 300,
                     high_quantile = .95)

```



Quality control can then be checked in a vln plot and the numbers of gene and cells removed per step can be observed in a table:

<img src="QC" align="center" width="600">
<img src="QC" align="center" width="600">
<img src="QCTABLE" align="center" width="600">

We observed that most cells were removed due to increased mitochondrial content. Depending on the experimental design, the mitochondrial content threshold can be adjusted to retain a higher number of cells, if minimizing cell loss is of relevance.

## Data integration

After quality control the prefered integration method can be chosen within Seurat's `r IntegrateLayers` function. Additionally, we implemented a new wrapper function for the scVI Integration from the scvi-tools package. After the integration completes, we run the Leiden algorithm to find clusters and generate UMAP embeddings.

```{r Integration}
#Integration through Seurat
Seu_obj <- IntegrateLayers(object = Seu_obj,
                           method = CCAIntegration,
                           orig.reduction = "pca",
                           new.reduction = "integrated.cca",
                           verbose = T)

#After Integration we join the layers 
Seu_obj <- JoinLayers(Seu_obj)

#Integration with scVI
Seu_obj <- DO.scVI(Seu_object = Seu_obj,
                   batch_key ="orig.ident",
                   layer_counts = "counts",
                   layer_logcounts = "logcounts")

```

After the integration finished, both corrected expression matrices can be found saved in the Seurat object and can be used for cluster calculations and UMAP projections. In this case, we will continue with Seuratv5 CCA Integration method.

```{r Clustering and UMAP}
Seu_obj <- FindNeighbors(object = Seu_obj, reduction = "integrated.cca", dims = 1:50) #change dims accrodingly
Seu_obj <- FindClusters(Seu_obj, resolution = 0.3, algorithm=4, random.seed = 1234)
Seu_obj <- RunUMAP(object = Seu_obj, reduction = "integrated.cca", dims = 1:50)

DO.UMAP(Seu_obj, group.by = "seurat_clusters")
DO.UMAP(Seu_obj, group.by = "condition", legend.position = "right", label = F)

```


## Semi-automatic annotation with Celltypist

Next up, we implemented a wrapper around the semi-automatic annotation tool `r CellTypist`. It will annotate the defined clusters based on the `r Adult_COVID19_PBMC.pkl` model.

```{r}
Seu_obj <- DO.CellTypist(Seu_obj,
                         modelName = "Healthy_COVID19_PBMC.pkl", 
                         runCelltypistUpdate=F,
                         over_clustering = "seurat_clusters")

```


# Session information

```{r session_info, echo=FALSE}
options(width = 120)
sessioninfo::session_info()
```

# Bibliography

```{r vignetteBiblio, results = "asis", echo = FALSE, warning = FALSE, message = FALSE}
## Print bibliography
PrintBibliography(bib, .opts = list(hyperlink = "to.doc", style = "html"))
```
